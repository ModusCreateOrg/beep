<template>
    <ion-page class="ion-page">
        <ion-header>
            <ion-toolbar>
                <ion-buttons slot="start">
                    <ion-back-button></ion-back-button>
                </ion-buttons>
                <ion-title>Account page</ion-title>
            </ion-toolbar>
        </ion-header>

        <ion-content class="content" padding>
            <ion-list>
                <ion-item>
                    <ion-icon name="person" slot="start"></ion-icon>
                    <ion-input type="text" :value="account" @input="account = $event.target.value"></ion-input>
                </ion-item>
                <ion-item>
                    <ion-checkbox @change="toggleIncludeUnverified" :checked="includeUnverified"></ion-checkbox>
                    <ion-label>Include Unverified</ion-label>
                </ion-item>
            </ion-list>

            <ion-button expand="full" @click="checkAccount" :disabled="!validateAccount()">
                <span v-if="requestPending">
                    <ion-spinner></ion-spinner>
                </span>
                <span v-else>Have I been pwned?</span>
            </ion-button>

            <div>
                <ion-card no-margin v-if="isSubmitted">
                    <ion-card-content text-center>
                        <i>{{accountChecked}}</i> is
                        <strong>
                            <ion-badge :color="breaches.length ? 'danger' : 'success'">
                                <span v-if="breaches.length">pwned {{breaches.length}} times</span>
                                <span v-else>not pwned, yet...</span>
                            </ion-badge>
                        </strong>
                    </ion-card-content>
                </ion-card>
                <breach v-for="(breach, index) in breaches" :key="index" :breach="breach"></breach>
            </div>
        </ion-content>
    </ion-page>
</template>

<script>
import axios from 'axios'
import Breach from './Breach.vue'


const baseURL = 'https://haveibeenpwned.com/api/v2/breachedaccount/'

export default {
    name: 'acc',
    components: {
        Breach,
    },
    data() {
        return {
            account: '',
            accountChecked: '',
            requestPending: false,
            isSubmitted: false,
            includeUnverified: false,
            breaches: [],
        }
    },
    methods: {
        validateAccount() {
            return this.account.trim()
        },
        getURL() {
            let url = baseURL + this.account
            if (this.includeUnverified) {
                url += '?includeUnverified=true'
            }
            return url
        },
        toggleIncludeUnverified() {
            this.includeUnverified = !this.includeUnverified
        },
        checkAccount() {
            if (!this.requestPending && this.validateAccount()) {
                this.reset()
                this.sendRequest()
            }
        },
        reset() {
            this.isSubmitted = false
            this.breaches = []
            this.accountChecked = this.account
        },
        async sendRequest() {
            const loading = await this.$glob.api.newLoadingController({
                content: 'Fetching breach details...',
            })

            loading.present()
            this.requestPending = true

            axios.get(this.getURL())
                .then(response => {
                    this.breaches = response.data
                })
                .catch(err => {
                    // 404 means account not pwned
                    if (err.response && err.response.status === 404) {
                        this.breaches = []
                        return
                    }
                    this.showError()
                })
                .finally(() => {
                    this.account = ''
                    this.isSubmitted = true
                    this.requestPending = false
                    loading.dismiss()
                })
        },
        showError() {
            this.$glob.api.newAlertController({
                header: 'Error',
                message: 'Something went wrong...',
                buttons: ['OK'],
            }).then(e => e.present())
        }
    },
}
</script>

<style>
ion-icon {
    font-size: 25px;
}

ion-spinner * {
    stroke: white !important
}
</style>
